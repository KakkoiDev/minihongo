<!doctype html>
<html lang="{{HTML_LANG}}">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <base href="{{BASE_URL}}">
  <title><slot name="title">Minihongo</slot></title>
  <script>
    var t = localStorage.getItem('theme') ||
      (matchMedia('(prefers-color-scheme:dark)').matches ? 'dark' : 'light')
    document.documentElement.dataset.theme = t
    if (localStorage.getItem('furigana') === '0')
      document.documentElement.classList.add('no-furigana')
  </script>
  <link rel="stylesheet" href="/static/style.css">
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#BC002D">
  <link rel="icon" href="/static/logo.svg" type="image/svg+xml">
  <link rel="apple-touch-icon" href="/static/icon-192.png">
</head>
<body>
  <nav>
    <a href="./" class="logo" lang="ja">ミニ本語</a>
    <a href="lessons/2-vocabulary.html">{{NAV_VOCABULARY}}</a>
    <a href="lessons/3-grammar.html">{{NAV_GRAMMAR}}</a>
    <a href="lessons/5-word-building.html">{{NAV_WORD_BUILDING}}</a>
    <a href="lessons/6-texts-dialogs.html">{{NAV_READING}}</a>
    <button class="nav-toggle" onclick="toggleFurigana()">{{FURIGANA_LABEL}}</button>
    <button class="nav-toggle" onclick="toggleTheme()">{{DARK_MODE_LABEL}}</button>
    {{LANG_SWITCHER}}
  </nav>

  <div id="toast"><span class="toast-msg"></span></div>

  <main id="content">
    <slot></slot>
  </main>

  <footer>
    <a href="https://github.com/KakkoiDev/minihongo">GitHub</a>
    <span>&copy; {{COPYRIGHT_YEAR}} KakkoiDev</span>
  </footer>

  <!-- htmz: partial page loads via hidden iframe -->
  <script>
    const base = document.querySelector('base').href
    const basePath = new URL(base).pathname

    function onHtmzLoad(frame) {
      const loc = frame.contentWindow.location
      if (loc.href === 'about:blank') return
      setTimeout(() => {
        const target = document.querySelector(loc.hash || null)
        if (!target) return
        // Original htmz swap
        target.replaceWith(...frame.contentDocument.body.childNodes)
        // Clear iframe history entry
        frame.remove()
        document.body.appendChild(frame)
        // URL history
        const pagePath = loc.pathname.replace(basePath, '').replace(/^_f\//, '')
        const pageUrl = base + pagePath
        const h1 = document.querySelector('#content h1')
        document.title = (h1?.textContent || 'Minihongo') + ' - Minihongo'
        if (location.href !== pageUrl) history.pushState({ path: pagePath }, '', pageUrl)
      })
    }

    // Back/forward
    addEventListener('popstate', e => {
      if (!e.state?.path) return location.reload()
      fetch(base + '_f/' + e.state.path + '#content')
        .then(r => r.text())
        .then(html => {
          const doc = new DOMParser().parseFromString(html, 'text/html')
          document.querySelector('#content')?.replaceWith(...doc.body.childNodes)
          const h1 = document.querySelector('#content h1')
          document.title = (h1?.textContent || 'Minihongo') + ' - Minihongo'
        })
    })

    // Rewrite nav links for htmz
    document.querySelectorAll('nav:not(.lesson-nav) a:not(.logo)').forEach(a => {
      if (a.classList.contains('lang-link')) return
      a.target = 'htmz'
      const path = new URL(a.href).pathname.replace(basePath, '')
      a.href = base + '_f/' + path + '#content'
    })

    // Intercept in-page anchor links (TOC etc.) broken by <base href>
    document.addEventListener('click', e => {
      const a = e.target.closest('#content a[href^="#"]')
      if (a) {
        e.preventDefault()
        const el = document.getElementById(a.getAttribute('href').slice(1))
        if (el) el.scrollIntoView()
        return
      }
      // Intercept lesson-nav links via event delegation
      const nav = e.target.closest('.lesson-nav a')
      if (!nav) return
      e.preventDefault()
      const path = new URL(nav.href, base).pathname.replace(basePath, '')
      document.querySelector('iframe[name=htmz]').src = base + '_f/' + path + '#content'
    })

    function toggleTheme() {
      const next = document.documentElement.dataset.theme === 'dark' ? 'light' : 'dark'
      document.documentElement.dataset.theme = next
      localStorage.setItem('theme', next)
    }

    function toggleFurigana() {
      const on = document.documentElement.classList.toggle('no-furigana')
      localStorage.setItem('furigana', on ? '0' : '1')
    }

    navigator.serviceWorker?.register('/sw.js')

    // Toast banner system
    const TOAST = {
      offline: '{{TOAST_OFFLINE}}',
      online: '{{TOAST_ONLINE}}',
      install: '{{TOAST_INSTALL}}',
      installBtn: '{{TOAST_INSTALL_BTN}}',
      updated: '{{TOAST_UPDATED}}'
    }

    const toast = document.getElementById('toast')
    const toastMsg = toast.querySelector('.toast-msg')
    let toastTimer = 0

    let toastOnDismiss = null

    function showToast(msg, opts) {
      clearTimeout(toastTimer)
      toastMsg.textContent = msg
      const old = toast.querySelector('.toast-btn')
      if (old) old.remove()
      toastOnDismiss = opts?.onDismiss || null
      if (opts?.actionLabel) {
        const btn = document.createElement('button')
        btn.className = 'toast-btn'
        btn.textContent = opts.actionLabel
        btn.onclick = e => { e.stopPropagation(); opts.action?.() }
        toast.appendChild(btn)
      }
      toast.classList.add('visible')
      if (opts?.duration) toastTimer = setTimeout(hideToast, opts.duration)
    }

    function hideToast() {
      clearTimeout(toastTimer)
      toast.classList.remove('visible')
      if (toastOnDismiss) { toastOnDismiss(); toastOnDismiss = null }
    }

    toast.addEventListener('click', hideToast)

    addEventListener('offline', () => showToast(TOAST.offline))
    addEventListener('online', () => showToast(TOAST.online, { duration: 3000 }))

    let deferredInstall = null
    addEventListener('beforeinstallprompt', e => {
      e.preventDefault()
      deferredInstall = e
      const dismissed = localStorage.getItem('install_dismissed')
      if (dismissed && Date.now() - Number(dismissed) < 7 * 86400000) return
      showToast(TOAST.install, {
        actionLabel: TOAST.installBtn,
        action() {
          deferredInstall?.prompt()
          deferredInstall = null
          toastOnDismiss = null
          hideToast()
        },
        onDismiss() { localStorage.setItem('install_dismissed', Date.now()) }
      })
    })

    navigator.serviceWorker?.addEventListener('controllerchange', () => {
      showToast(TOAST.updated, { duration: 4000 })
    })
  </script>
  <iframe hidden name="htmz" onload="onHtmzLoad(this)"></iframe>
</body>
</html>
